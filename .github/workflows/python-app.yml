name: Python application

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  # Linux_x86-64:
  #   runs-on: ubuntu-18.04

  #   steps:
  #   - uses: actions/checkout@v2
  #     with:
  #       fetch-depth: 0

  #   - name: Set up Python 3.9
  #     uses: actions/setup-python@v2
  #     with:
  #       python-version: 3.9

  #   - name: Install dependencies
  #     run: |
  #       python -m pip install --upgrade pip pipenv

  #   - name: Check Python version
  #     run: |
  #       which python
  #       python --version
  #       which python3
  #       python3 --version
  #       which python3.9
  #       python3.9 --version
  #       which pipenv
  #       pipenv --version

  #   - name: Update version
  #     run: fsbuild/version --update --auto

  #   - name: Run pipenv install
  #     run: |
  #       pipenv install --deploy
        
  #   - name: Build
  #     run: |
  #       pipenv run fsbuild/build

  #   - name: Bundle
  #     run: |
  #       pipenv run fsbuild/bundle

  #   - name: Archive
  #     run: fsbuild/archive

  #   - uses: actions/upload-artifact@v2
  #     with:
  #       name: Linux_x86-64
  #       path: fsbuild/_dist/*

  #   - name: Install dropbox package
  #     run: python3 -m pip install dropbox

  #   - name: Upload build to Dropbox folder
  #     run: fsbuild/upload
  #     env:
  #       DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
  #       DROPBOX_ACCESS_TOKEN: ${{ secrets.DROPBOX_ACCESS_TOKEN }}

  Windows_x86-64:
    runs-on: windows-2016

    # defaults:
    #   run:
    #     shell: msys2 {0}
       
    defaults:
      run:
        shell: msys2 {0}

    steps:

    - uses: actions/checkout@v2
      with:
        fetch-depth: 0

    - uses: msys2/setup-msys2@v2
      with:
        path-type: inherit

    - name: Download Python
      run: |
        wget https://www.python.org/ftp/python/3.9.2/python-3.9.2-amd64.exe
        # FIXME: Check SHA-1?

    - name: Install Python
      shell: cmd
      run: |
        START /WAIT python-3.9.2-amd64.exe /install /quiet PrependPath=1

    - name: Add Python to PATH
      run: |
        echo $LOCALAPPDATA/Programs/Python/Python39/Scripts >> $GITHUB_PATH  
        echo $LOCALAPPDATA/Programs/Python/Python39 >> $GITHUB_PATH

    - name: Check PATH
      shell: msys2 {0}
      run: |
        echo $PATH

    - name: Env
      shell: msys2 {0}
      run: |
        env

    # - name: Set up Python 3.9
    #   uses: actions/setup-python@v2
    #   with:
    #     python-version: 3.9

    - name: Check Python version
      run: |
       python3 -c "import sys; print(sys.path)"

    # - name: Check PATH
    #   run: |
    #    $Env:Path

    # - uses: msys2/setup-msys2@v2
    #   with:
    #     path-type: inherit

    - name: Install dependencies
      run: |
        python3 -m pip install --upgrade pip pipenv

    - name: Check python version
      shell: msys2 {0}
      run: |
        # export PATH="$pythonLocation:$PATH"
        # which python
        # python --version
        which python3
        python3 --version
        # pipenv --version

    - name: Update version
      shell: msys2 {0}
      run: |
        pwd
        ls
        fsbuild/version --update --auto

    - name: Run pipenv install
      shell: msys2 {0}
      run: |
        pipenv install --deploy

    - name: Build
      run: |
        pipenv run fsbuild/build

    - name: Bundle
      run: |
        pipenv run fsbuild/bundle

    - name: Archive
      run: fsbuild/archive

    - uses: actions/upload-artifact@v2
      with:
        name: Linux_x86-64
        path: fsbuild/_dist/*

    - name: Install dropbox package
      run: python3 -m pip install dropbox

    - name: Upload build to Dropbox folder
      run: fsbuild/upload
      env:
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        DROPBOX_ACCESS_TOKEN: ${{ secrets.DROPBOX_ACCESS_TOKEN }}
